<!DOCTYPE html><html lang="en"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Objection Mayhem</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#f59e0b',
                        court: {
                            light: '#f8f9fa',
                            dark: '#27272a',
                        }
                    },
                    animation: {
                        'pulse-once': 'pulse 1s ease-in-out 1',
                    }
                }
            }
        };
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes appear {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .appear {
            animation: appear 0.4s ease-out forwards;
        }

        .gavel-animation {
            animation: gavel 0.7s ease-in-out;
        }

        @keyframes gavel {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(-20deg); }
            50% { transform: rotate(0deg); }
            75% { transform: rotate(-10deg); }
            100% { transform: rotate(0deg); }
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(93, 92, 222, 0.5);
            border-radius: 10px;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(93, 92, 222, 0.7);
        }

        /* Update these styles in the <style> section */
        .progress-step {
            transition: all 0.3s ease;
            min-width: 70px; /* Minimum width for each step */
        }

        .progress-step span {
            text-align: center;
            white-space: normal; /* Allow text to wrap */
            max-width: 100px; /* Increased from 80px */
            font-size: 0.75rem;
            line-height: 1.2;
            margin-top: 0.25rem;
            display: block;
            overflow: visible; /* Remove truncation */
            text-overflow: clip;
            height: 2.4rem; /* Allow for two lines of text */
        }

        .progress-step[data-side="prosecution"] .w-10 {
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .progress-step[data-side="defense"] .w-10 {
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        #witness-progress-container {
            scroll-behavior: smooth;
            padding: 4px 0;
            gap: 1rem; /* Increase spacing between witnesses */
        }

    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen transition-colors duration-300">
    <!-- Add modal for objection details -->
    <div id="objection-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 id="modal-title" class="text-2xl font-bold text-primary"></h2>
                    <button id="close-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="modal-content" class="space-y-4">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Role Switch Modal -->
    <div id="role-switch-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 max-w-lg mx-4 fade-slide-in">
            <div class="text-center mb-6">
                <div class="inline-block p-4 rounded-full bg-primary bg-opacity-20 mb-4">
                    <i class="fas fa-sync-alt text-primary text-3xl"></i>
                </div>
                <h2 class="text-2xl font-bold">Switching Roles</h2>
            </div>
            
            <p class="mb-4">The prosecution has completed their case.</p>
            <p class="mb-6">You are now switching roles to act as the <span class="font-bold text-primary">prosecutor's objection assistant</span>. Your job is to monitor the defense attorney's questions and object when they violate the rules of evidence. Although you're not asking the questions yourself, your vigilance helps ensure a fair trial.</p>
            
            <div class="text-center">
                <button id="continue-trial" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors">
                    Continue to Defense Case
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <div class="flex justify-center items-center mb-2">
                <i class="fas fa-gavel text-primary text-4xl md:text-5xl mr-3" id="gavel-icon"></i>
                <h1 class="text-3xl md:text-5xl font-bold">Objection Mayhem</h1>
            </div>
            <p class="text-lg text-gray-600 dark:text-gray-300 mt-2">Think like a trial attorney and identify valid objections!</p>
        </header>

        <!-- Game Container -->
        <div class="bg-court-light dark:bg-court-dark rounded-lg shadow-lg p-6 mb-8" id="game-container">
            <!-- Start Screen -->
            <div id="start-screen" class="flex flex-col items-center justify-center">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md w-full max-w-2xl mb-8">
                    <h2 class="text-2xl font-bold mb-4 text-center text-primary">Welcome to the Courtroom!</h2>
                    <p class="mb-4">In <span class="font-semibold">Objection Mayhem</span>, you'll play the role of a trial attorney who must identify valid objections during direct and cross-examinations.</p>
                    <p class="mb-4">For each question, decide whether there's a valid objection and select the correct legal basis. If the question is proper, select "No Objection".</p>
                    <p class="mb-6">Choose your difficulty level to begin:</p>
                    
                    <div class="flex flex-wrap justify-center gap-4">
                        <button class="difficulty-btn flex-1 px-6 py-3 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-100 rounded-lg font-medium hover:bg-green-200 dark:hover:bg-green-800 transition-colors" data-difficulty="easy">
                            Easy
                        </button>
                        <button class="difficulty-btn flex-1 px-6 py-3 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-100 rounded-lg font-medium hover:bg-yellow-200 dark:hover:bg-yellow-800 transition-colors" data-difficulty="medium">
                            Medium
                        </button>
                        <button class="difficulty-btn flex-1 px-6 py-3 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-100 rounded-lg font-medium hover:bg-red-200 dark:hover:bg-red-800 transition-colors" data-difficulty="hard">
                            Hard
                        </button>
                    </div>
                    
                    <!-- Add Trial Mode Button -->
                    <div class="mt-4">
                        <button class="difficulty-btn px-6 py-3 bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-100 rounded-lg font-medium hover:bg-purple-200 dark:hover:bg-purple-800 transition-colors w-full" data-difficulty="trial">
                            <i class="fas fa-balance-scale mr-2"></i> Trial Mode
                        </button>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Experience complete trial scenarios with connected questions.</p>
                    </div>
                </div>
                
                <!-- Objection Types Section -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md w-full max-w-2xl mx-auto">
                    <h3 class="text-2xl font-semibold mb-6 text-primary text-center">Objection Types</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <!-- Card 1 -->
                      <div class="objection-card border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer" data-objection="relevance">
                        <h4 class="font-semibold text-primary mb-1">Relevance</h4>
                        <p class="text-sm text-gray-700 dark:text-gray-300">
                          Question has no bearing on the issues of the case.
                        </p>
                      </div>
                      
                      <!-- Card 2 -->
                      <div class="objection-card border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer" data-objection="hearsay">
                        <h4 class="font-semibold text-primary mb-1">Hearsay</h4>
                        <p class="text-sm text-gray-700 dark:text-gray-300">
                          Out-of-court statements offered to prove the truth.
                        </p>
                      </div>
                      
                      <!-- Card 3 -->
                      <div class="objection-card border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer" data-objection="leading">
                        <h4 class="font-semibold text-primary mb-1">Leading</h4>
                        <p class="text-sm text-gray-700 dark:text-gray-300">
                          Suggests the answer within the question (direct exam).
                        </p>
                      </div>
                      
                      <!-- Card 4 -->
                      <div class="objection-card border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer" data-objection="speculation">
                        <h4 class="font-semibold text-primary mb-1">Speculation</h4>
                        <p class="text-sm text-gray-700 dark:text-gray-300">
                          Asks witness to guess or assume.
                        </p>
                      </div>
                      
                      <!-- Card 5 -->
                      <div class="objection-card border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer" data-objection="compound">
                        <h4 class="font-semibold text-primary mb-1">Compound</h4>
                        <p class="text-sm text-gray-700 dark:text-gray-300">
                          Contains multiple questions in one.
                        </p>
                      </div>
                      
                      <!-- Card 6 -->
                      <div class="objection-card border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer" data-objection="assumes-facts">
                        <h4 class="font-semibold text-primary mb-1">Assumes Facts</h4>
                        <p class="text-sm text-gray-700 dark:text-gray-300">
                          Presumes unproven facts.
                        </p>
                      </div>
                      
                      <!-- Card 7 -->
                      <div class="objection-card border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer" data-objection="argumentative">
                        <h4 class="font-semibold text-primary mb-1">Argumentative</h4>
                        <p class="text-sm text-gray-700 dark:text-gray-300">
                          Challenges witness rather than seeks information.
                        </p>
                      </div>
                      
                      <!-- Card 8 -->
                      <div class="objection-card border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer" data-objection="narrative">
                        <h4 class="font-semibold text-primary mb-1">Narrative</h4>
                        <p class="text-sm text-gray-700 dark:text-gray-300">
                          Invites an open-ended explanation.
                        </p>
                      </div>
                      
                      <!-- Card 9 -->
                      <div class="objection-card border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer" data-objection="legal-conclusion">
                        <h4 class="font-semibold text-primary mb-1">Legal Conclusion</h4>
                        <p class="text-sm text-gray-700 dark:text-gray-300">
                          Asks witness to interpret law.
                        </p>
                      </div>
                      
                      <!-- Card 10 -->
                      <div class="objection-card border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer" data-objection="vague">
                        <h4 class="font-semibold text-primary mb-1">Vague/Ambiguous</h4>
                        <p class="text-sm text-gray-700 dark:text-gray-300">
                          Question is unclear or confusing.
                        </p>
                      </div>
                    </div>
                  </div>
            </div>

            <!-- Trial Selection Screen (initially hidden) -->
            <div id="trial-selection-screen" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-primary">
                        <i class="fas fa-balance-scale mr-2"></i> Select a Trial
                    </h2>
                    <button id="back-to-home" class="text-gray-600 dark:text-gray-300 hover:text-red-500 dark:hover:text-red-400 transition">
                        <i class="fas fa-arrow-left mr-1"></i> Back
                    </button>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                    <p class="mb-4 text-gray-600 dark:text-gray-300">
                        Choose a trial scenario to experience a complete courtroom storyline.
                    </p>
                    
                    <div id="trial-list" class="mt-4">
                        <!-- Trial buttons will be generated here -->
                        <div class="text-center py-6 text-gray-400">
                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                            <p>Loading trials...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Game Screen (initially hidden) -->
            <div id="game-screen" class="hidden">
                <!-- Score and Progress -->
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                    <div class="flex items-center mb-3 sm:mb-0">
                        <div class="text-lg font-medium">Score: <span id="score" class="text-primary font-bold">0</span></div>
                        <div class="text-lg font-medium ml-5">Question: <span id="question-number" class="text-primary font-bold">1</span>/<span id="total-questions">10</span></div>
                    </div>
                    <div class="flex items-center">
                        <div id="difficulty-display" class="px-3 py-1 rounded-full text-sm font-medium mr-4"></div>
                        <button id="end-game" class="text-gray-600 dark:text-gray-300 hover:text-red-500 dark:hover:text-red-400 transition">
                            <i class="fas fa-times-circle mr-1"></i> End Game
                        </button>
                    </div>
                </div>

                <!-- Courtroom Scene -->
                <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-5 mb-6">
                    <!-- Examination Type Status Bar -->
                    <div id="examination-status" class="mb-3 flex items-center">
                        <div class="px-3 py-1 rounded-full text-sm font-medium mr-3" id="examination-type-badge">Direct Examination</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">
                            <span id="examination-role">You are assisting as defense counsel</span>
                        </div>
                    </div>
                    
                    <div class="flex items-start mb-4">
                        <div class="flex-shrink-0 w-8 text-primary">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1" id="question-context">Direct Examination of Witness</div>
                            <p class="text-lg font-medium" id="question-text">Loading question...</p>
                        </div>
                    </div>
                </div>

                <!-- Trial Progress (initially hidden) - MOVED HERE -->
                <div id="trial-progress" class="mb-6 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md hidden">
                    <h3 class="font-medium mb-3">Trial Progress</h3>
                    <div class="flex overflow-x-auto pb-2 custom-scrollbar">
                        <div id="witness-progress-container" class="flex space-x-1 min-w-max">
                            <!-- Witness steps will be generated dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Objection Buttons -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">Choose Your Objection:</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2 mb-4">
                        <button class="objection-btn px-2 py-3 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-primary hover:text-white dark:hover:bg-primary text-sm transition-colors" data-objection="relevance">Relevance</button>
                        <button class="objection-btn px-2 py-3 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-primary hover:text-white dark:hover:bg-primary text-sm transition-colors" data-objection="hearsay">Hearsay</button>
                        <button class="objection-btn px-2 py-3 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-primary hover:text-white dark:hover:bg-primary text-sm transition-colors" data-objection="leading">Leading</button>
                        <button class="objection-btn px-2 py-3 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-primary hover:text-white dark:hover:bg-primary text-sm transition-colors" data-objection="speculation">Speculation</button>
                        <button class="objection-btn px-2 py-3 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-primary hover:text-white dark:hover:bg-primary text-sm transition-colors" data-objection="compound">Compound</button>
                        <button class="objection-btn px-2 py-3 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-primary hover:text-white dark:hover:bg-primary text-sm transition-colors" data-objection="assumes-facts">Assumes Facts</button>
                        <button class="objection-btn px-2 py-3 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-primary hover:text-white dark:hover:bg-primary text-sm transition-colors" data-objection="argumentative">Argumentative</button>
                        <button class="objection-btn px-2 py-3 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-primary hover:text-white dark:hover:bg-primary text-sm transition-colors" data-objection="narrative">Calls for Narrative</button>
                        <button class="objection-btn px-2 py-3 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-primary hover:text-white dark:hover:bg-primary text-sm transition-colors" data-objection="legal-conclusion">Legal Conclusion</button>
                        <button class="objection-btn px-2 py-3 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-primary hover:text-white dark:hover:bg-primary text-sm transition-colors" data-objection="vague">Vague/Ambiguous</button>
                    </div>
                    <button id="no-objection" class="w-full py-3 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 font-medium transition-colors">No Objection</button>
                </div>

                <!-- Feedback Area (Initially Hidden) -->
                <div id="feedback-container" class="hidden mb-6 p-4 rounded-lg">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 mt-1 mr-3">
                            <i id="feedback-icon" class="fas fa-check-circle text-2xl text-green-500"></i>
                        </div>
                        <div class="flex-1">
                            <h3 id="feedback-title" class="font-bold mb-2 text-lg">Correct!</h3>
                            <p id="feedback-text" class="mb-2"></p>
                            <div id="correct-objection" class="mb-2 font-medium"></div>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button id="next-question" class="px-5 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors">Next Question</button>
                    </div>
                </div>
            </div>

            <!-- Results Screen (initially hidden) -->
            <div id="results-screen" class="hidden">
                <div class="text-center mb-6">
                    <div class="inline-block rounded-full bg-primary bg-opacity-20 p-5 mb-4">
                        <i class="fas fa-trophy text-primary text-5xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-2">Game Completed!</h2>
                    <div class="text-xl">Final Score: <span id="final-score" class="font-bold text-primary">0</span>/<span id="total-possible">10</span></div>
                    <div id="performance-message" class="mt-2 text-lg"></div>
                </div>
                
                <div class="mb-6 bg-white dark:bg-gray-800 rounded-lg p-6 shadow">
                    <h3 class="text-xl font-bold mb-4">Your Performance</h3>
                    <div class="flex flex-col md:flex-row gap-4 justify-between">
                        <div class="flex-1">
                            <div class="mb-3">
                                <div class="text-sm text-gray-500 dark:text-gray-400">Correct Objections</div>
                                <div class="text-3xl font-bold text-green-500" id="correct-objections">0</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">Highest Streak</div>
                                <div class="text-3xl font-bold text-primary" id="highest-streak">0</div>
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="mb-3">
                                <div class="text-sm text-gray-500 dark:text-gray-400">Incorrect Objections</div>
                                <div class="text-3xl font-bold text-red-500" id="incorrect-objections">0</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">Accuracy</div>
                                <div class="text-3xl font-bold text-blue-500" id="accuracy-percentage">0%</                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Certificate section -->
                <div class="mb-6 bg-white dark:bg-gray-800 rounded-lg p-6 shadow">
                    <h3 class="text-xl font-bold mb-4">Get Your Certificate</h3>
                    <div class="mb-4">
                        <label for="player-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Enter your name:</label>
                        <input type="text" id="player-name" class="w-full px-4 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="John Doe">
                    </div>
                    <button id="generate-certificate" class="w-full px-6 py-3 bg-secondary text-white rounded-lg hover:bg-opacity-90 transition-colors">
                        <i class="fas fa-certificate mr-2"></i> Generate Certificate
                    </button>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button id="play-again" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors">
                        <i class="fas fa-redo mr-2"></i> Play Again
                    </button>
                    <button id="return-home" class="px-6 py-3 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        <i class="fas fa-home mr-2"></i> Return to Home
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Dark Mode Toggle -->
        <div class="fixed bottom-4 right-4">
            <button id="theme-toggle" class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center shadow-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                <i class="fas fa-moon dark:hidden"></i>
                <i class="fas fa-sun hidden dark:block"></i>
            </button>
        </div>
    </div>

    <script>
        // Dark mode detection and toggle
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        document.getElementById('theme-toggle').addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
        });

        // Game state variables
        let gameState = {
            difficulty: null,
            score: 0,
            questionsAsked: 0,
            totalQuestions: 10,
            currentQuestion: null,
            currentStreak: 0,
            highestStreak: 0,
            correctAnswers: 0,
            incorrectAnswers: 0,
            questionBank: [],
            usedQuestions: [],
            currentTrial: null, // Add trial tracking
            trialName: null     // Add trial name tracking
        };

        let questionBanks = {}; // Empty object to store questions

// Load questions from JSON file
async function loadQuestions() {
    try {
        const response = await fetch('questions.json'); // Fetch the JSON file
        if (!response.ok) throw new Error("Failed to load questions");
        questionBanks = await response.json(); // Store the JSON data
        console.log("Questions loaded:", questionBanks);
    } catch (error) {
        console.error("Error loading questions:", error);
        // Add fallback questions in case JSON loading fails
        questionBanks = {
            easy: [],
            medium: [],
            hard: [],
            trials: []
        };
    }
}

// Add function to select a random trial
function selectRandomTrial() {
    if (!questionBanks.trials || !Array.isArray(questionBanks.trials) || questionBanks.trials.length === 0) {
        console.error("No trials available!");
        // Return a default trial if none are available
        return {
            name: "Demo Trial",
            questions: [
                {
                    context: "Direct Examination",
                    question: "Please state your name for the record.",
                    correctObjections: ["no-objection"],
                    explanation: "This is a proper question to establish identity."
                }
            ]
        };
    }
    
    const trials = questionBanks.trials;
    const randomIndex = Math.floor(Math.random() * trials.length);
    return trials[randomIndex];
}

// Create confetti animation
function createConfetti() {
    const canvas = document.createElement('canvas');
    canvas.id = 'confetti-canvas';
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    canvas.style.position = 'fixed';
    canvas.style.top = '0';
    canvas.style.left = '0';
    canvas.style.pointerEvents = 'none';
    canvas.style.zIndex = '100';
    document.body.appendChild(canvas);
    
    const ctx = canvas.getContext('2d');
    const pieces = [];
    const colors = ['#5D5CDE', '#f59e0b', '#10B981', '#3B82F6', '#EC4899'];
    
    // Create confetti pieces
    for (let i = 0; i < 150; i++) {
        pieces.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height - canvas.height,
            size: Math.random() * 10 + 5,
            color: colors[Math.floor(Math.random() * colors.length)],
            speed: Math.random() * 3 + 2,
            angle: Math.random() * 6.28,
            spin: Math.random() * 0.2 - 0.1
        });
    }
    
    let animationFrameId;
    
    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        let stillFalling = false;
        
        pieces.forEach(piece => {
            piece.y += piece.speed;
            piece.angle += piece.spin;
            
            ctx.save();
            ctx.translate(piece.x, piece.y);
            ctx.rotate(piece.angle);
            
            ctx.fillStyle = piece.color;
            ctx.fillRect(-piece.size / 2, -piece.size / 2, piece.size, piece.size);
            
            ctx.restore();
            
            if (piece.y < canvas.height + piece.size) {
                stillFalling = true;
            }
        });
        
        if (stillFalling) {
            animationFrameId = requestAnimationFrame(animate);
        } else {
            cancelAnimationFrame(animationFrameId);
            document.body.removeChild(canvas);
        }
    }
    
    animate();
    
    // Remove confetti after 4 seconds
    setTimeout(() => {
        if (document.body.contains(canvas)) {
            cancelAnimationFrame(animationFrameId);
            document.body.removeChild(canvas);
        }
    }, 4000);
}

// Function to get a random "easy" question
function getRandomEasyQuestion() {
    if (!questionBanks.easy || questionBanks.easy.length === 0) {
        console.error("Questions not loaded yet!");
        return;
    }

    const questions = questionBanks.easy;
    const randomIndex = Math.floor(Math.random() * questions.length);
    const selectedQuestion = questions[randomIndex];

    // Update the HTML with the selected question
    document.getElementById("context").textContent = selectedQuestion.context;
    document.getElementById("question").textContent = selectedQuestion.question;
    document.getElementById("correct-objections").textContent = selectedQuestion.correctObjections.join(", ");
    document.getElementById("explanation").textContent = selectedQuestion.explanation;
}

// Load questions when the page starts
loadQuestions();

        // Initialize game elements
        const startScreen = document.getElementById('start-screen');
        const trialSelectionScreen = document.getElementById('trial-selection-screen');
        const gameScreen = document.getElementById('game-screen');
        const resultsScreen = document.getElementById('results-screen');
        const difficultyButtons = document.querySelectorAll('.difficulty-btn');
        const objectionButtons = document.querySelectorAll('.objection-btn');
        const noObjectionButton = document.getElementById('no-objection');
        const nextQuestionButton = document.getElementById('next-question');
        const gavelIcon = document.getElementById('gavel-icon');
        const feedbackContainer = document.getElementById('feedback-container');
        const playAgainButton = document.getElementById('play-again');
        const returnHomeButton = document.getElementById('return-home');
        const endGameButton = document.getElementById('end-game');
        const backToHomeButton = document.getElementById('back-to-home');

        // Gavel animation when clicked
        gavelIcon.addEventListener('click', () => {
            gavelIcon.classList.add('gavel-animation');
            setTimeout(() => {
                gavelIcon.classList.remove('gavel-animation');
            }, 700);
        });

        // Start game when difficulty selected
        difficultyButtons.forEach(button => {
            button.addEventListener('click', () => {
                const difficulty = button.dataset.difficulty;
                if (difficulty === 'trial') {
                    showTrialSelection();
                } else {
                    startGame(difficulty);
                }
            });
        });

        // Show trial selection screen
        function showTrialSelection() {
            startScreen.classList.add('hidden');
            trialSelectionScreen.classList.remove('hidden');
            
            // Generate trial options based on available trials
            const trialList = document.getElementById('trial-list');
            trialList.innerHTML = '';
            
            if (!questionBanks.trials || !Array.isArray(questionBanks.trials) || questionBanks.trials.length === 0) {
                trialList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-6">No trials available</p>';
                return;
            }
            
            // Create a button for each trial
            questionBanks.trials.forEach((trial, index) => {
                // Calculate total questions - handle both old and new trial formats
                let questionCount = 0;
                
                if (trial.witnesses && Array.isArray(trial.witnesses)) {
                    // New format with witnesses structure
                    trial.witnesses.forEach(witness => {
                        if (witness.questions && Array.isArray(witness.questions)) {
                            questionCount += witness.questions.length;
                        }
                    });
                } else if (trial.questions && Array.isArray(trial.questions)) {
                    // Old format with direct questions array
                    questionCount = trial.questions.length;
                }
                
                const trialButton = document.createElement('button');
                trialButton.className = 'w-full text-left p-4 bg-white dark:bg-gray-700 rounded-lg shadow-sm hover:shadow-md mb-3 transition-shadow';
                trialButton.innerHTML = `
                    <h3 class="text-xl font-semibold text-purple-800 dark:text-purple-300">${trial.name}</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">${questionCount} questions</p>
                `;
                trialButton.addEventListener('click', () => {
                    startTrialGame(index);
                });
                trialList.appendChild(trialButton);
            });
        }

        // Function to start a specific trial by index
        function startTrialGame(trialIndex) {
            const selectedTrial = questionBanks.trials[trialIndex];
            
            // Calculate total questions for the trial
            let totalQuestions = 0;
            let allQuestions = [];
            
            if (selectedTrial.witnesses && Array.isArray(selectedTrial.witnesses)) {
                // New format with witnesses structure
                selectedTrial.witnesses.forEach(witness => {
                    if (witness.questions && Array.isArray(witness.questions)) {
                        totalQuestions += witness.questions.length;
                        allQuestions = allQuestions.concat(witness.questions);
                    }
                });
            } else if (selectedTrial.questions && Array.isArray(selectedTrial.questions)) {
                // Old format with direct questions array
                totalQuestions = selectedTrial.questions.length;
                allQuestions = [...selectedTrial.questions];
            }
            
            // Updated game state for trial mode
            gameState = {
                difficulty: 'trial',
                score: 0,
                questionsAsked: 0,
                totalQuestions: totalQuestions,
                currentQuestion: null,
                currentStreak: 0,
                highestStreak: 0,
                correctAnswers: 0,
                incorrectAnswers: 0,
                questionBank: [], // Will be set when witness questions start
                usedQuestions: [],
                currentTrial: selectedTrial,
                trialName: selectedTrial.name,
                trialIndex: trialIndex,
                currentWitness: null,
                currentSide: null,
                witnessQuestions: [],
                allQuestions: allQuestions // Store all questions for reference
            };
            
            // Update UI
            document.getElementById('score').textContent = '0';
            document.getElementById('question-number').textContent = '1';
            document.getElementById('total-questions').textContent = gameState.totalQuestions;
            
            // Set difficulty display
            const difficultyDisplay = document.getElementById('difficulty-display');
            difficultyDisplay.textContent = `Trial: ${gameState.trialName}`;
            difficultyDisplay.classList.add('bg-purple-100', 'text-purple-800');
            difficultyDisplay.classList.remove('bg-green-100', 'bg-yellow-100', 'bg-red-100', 
                'text-green-800', 'text-yellow-800', 'text-red-800');
            
            // Hide the trial selection screen
            trialSelectionScreen.classList.add('hidden');
            
            // Initialize the trial progress bar
            initializeTrialProgress(selectedTrial);
            
            // Start the trial narrative
            trialNarrativeHandler.startTrial(selectedTrial, function(witnessData) {
                if (!witnessData) {
                    // End the trial if witnessData is null (user clicked skip)
                    endGame();
                    return;
                }
                
                // Update game state with current witness data
                gameState.currentWitness = witnessData.witness;
                gameState.currentSide = witnessData.side;
                gameState.questionBank = [...witnessData.questions];
                gameState.witnessQuestions = witnessData.questions.length;
                gameState.onWitnessComplete = witnessData.onWitnessComplete;
                
                // Show game screen and start questioning
                gameScreen.classList.remove('hidden');
                loadNextQuestionForTrial();
            });
        }

        // Initialize game with selected difficulty
        function startGame(difficulty) {
            // Only for non-trial modes
            if (difficulty === 'trial') {
                return;
            }

            gameState = {
                difficulty: difficulty,
                score: 0,
                questionsAsked: 0,
                totalQuestions: 10,
                currentQuestion: null,
                currentStreak: 0,
                highestStreak: 0,
                correctAnswers: 0,
                incorrectAnswers: 0,
                questionBank: [...questionBanks[difficulty]],
                usedQuestions: [],
                currentTrial: null,
                trialName: null
            };

            // Update UI for the current difficulty
            document.getElementById('score').textContent = '0';
            document.getElementById('question-number').textContent = '1';
            document.getElementById('total-questions').textContent = gameState.totalQuestions;
            
            // Set the difficulty display style
            const difficultyDisplay = document.getElementById('difficulty-display');
            switch(difficulty) {
                case 'easy':
                    difficultyDisplay.textContent = 'Easy';
                    difficultyDisplay.classList.add('bg-green-100', 'text-green-800');
                    difficultyDisplay.classList.remove('bg-yellow-100', 'bg-red-100', 'bg-purple-100', 
                        'text-yellow-800', 'text-red-800', 'text-purple-800');
                    break;
                case 'medium':
                    difficultyDisplay.textContent = 'Medium';
                    difficultyDisplay.classList.add('bg-yellow-100', 'text-yellow-800');
                    difficultyDisplay.classList.remove('bg-green-100', 'bg-red-100', 'bg-purple-100', 
                        'text-green-800', 'text-red-800', 'text-purple-800');
                    break;
                case 'hard':
                    difficultyDisplay.textContent = 'Hard';
                    difficultyDisplay.classList.add('bg-red-100', 'text-red-800');
                    difficultyDisplay.classList.remove('bg-green-100', 'bg-yellow-100', 'bg-purple-100', 
                        'text-green-800', 'text-yellow-800', 'text-purple-800');
                    break;
            }
            
            // Show game screen, hide start screen
            startScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            resultsScreen.classList.add('hidden');
            
            // Load first question
            loadNextQuestion();
        }

        function loadNextQuestion() {
            // Hide feedback container
            feedbackContainer.classList.add('hidden');
            
            // Enable all objection buttons
            objectionButtons.forEach(button => {
                button.disabled = false;
                button.classList.remove('bg-gray-300', 'cursor-not-allowed');
            });
            noObjectionButton.disabled = false;
            noObjectionButton.classList.remove('cursor-not-allowed');
            
            // Check if we've reached the total number of questions
            if (gameState.questionsAsked >= gameState.totalQuestions) {
                endGame();
                return;
            }
            
            if (gameState.difficulty === 'trial') {
                // For trial mode, questions must be used in sequence
                if (gameState.questionsAsked < gameState.questionBank.length) {
                    gameState.currentQuestion = gameState.questionBank[gameState.questionsAsked];
                    
                    // Update context to show trial progress
                    const contextElement = document.getElementById('question-context');
                    contextElement.textContent = `${gameState.trialName} - ${gameState.currentQuestion.context}`;
                    
                    // Update question text
                    document.getElementById('question-text').textContent = gameState.currentQuestion.question;
                    document.getElementById('question-number').textContent = gameState.questionsAsked + 1;
                }
            } else {
                // Select a random question from the bank
                if (gameState.questionBank.length === 0) {
                    // If we've used all questions, reset the bank
                    gameState.questionBank = [...gameState.usedQuestions];
                    gameState.usedQuestions = [];
                }
                
                // Existing random question selection logic
                const randomIndex = Math.floor(Math.random() * gameState.questionBank.length);
                gameState.currentQuestion = gameState.questionBank[randomIndex];
                
                // Remove the question from the bank and add to used questions
                gameState.questionBank.splice(randomIndex, 1);
                gameState.usedQuestions.push(gameState.currentQuestion);
                
                // Update the UI with the question
                document.getElementById('question-context').textContent = gameState.currentQuestion.context;
                document.getElementById('question-text').textContent = gameState.currentQuestion.question;
                document.getElementById('question-number').textContent = gameState.questionsAsked + 1;
            }
        }

        // Handle objection selection
        objectionButtons.forEach(button => {
            button.addEventListener('click', () => {
                const objection = button.dataset.objection;
                checkAnswer(objection);
            });
        });

        // Handle no objection selection
        noObjectionButton.addEventListener('click', () => {
            checkAnswer('no-objection');
        });

        // Check if the answer is correct
        function checkAnswer(selectedObjection) {
            const correctObjections = gameState.currentQuestion.correctObjections;
            const isCorrect = correctObjections.includes(selectedObjection);
            
            // Disable all objection buttons after selection
            objectionButtons.forEach(button => {
                button.disabled = true;
                button.classList.add('cursor-not-allowed');
            });
            noObjectionButton.disabled = true;
            noObjectionButton.classList.add('cursor-not-allowed');
            
            // Update scoring
            if (isCorrect) {
                gameState.score += 10;
                gameState.correctAnswers++;
                gameState.currentStreak++;
                if (gameState.currentStreak > gameState.highestStreak) {
                    gameState.highestStreak = gameState.currentStreak;
                }
            } else {
                gameState.incorrectAnswers++;
                gameState.currentStreak = 0;
            }
            
            // Update score display
            document.getElementById('score').textContent = gameState.score;
            
            // Show feedback
            showFeedback(isCorrect, selectedObjection);
            
            // Increment questions asked
            gameState.questionsAsked++;
        }

        // Show feedback based on answer
        function showFeedback(isCorrect, selectedObjection) {
            const feedbackContainer = document.getElementById('feedback-container');
            const feedbackIcon = document.getElementById('feedback-icon');
            const feedbackTitle = document.getElementById('feedback-title');
            const feedbackText = document.getElementById('feedback-text');
            const correctObjectionElement = document.getElementById('correct-objection');
            
            // Set feedback styles based on correctness
            if (isCorrect) {
                feedbackContainer.classList.remove('bg-red-100', 'dark:bg-red-900');
                feedbackContainer.classList.add('bg-green-100', 'dark:bg-green-900');
                feedbackIcon.classList.remove('fa-times-circle', 'text-red-500');
                feedbackIcon.classList.add('fa-check-circle', 'text-green-500');
                feedbackTitle.textContent = 'Correct!';
                feedbackTitle.classList.remove('text-red-700', 'dark:text-red-300');
                feedbackTitle.classList.add('text-green-700', 'dark:text-green-300');
                
                // Trigger confetti animation for correct answers
                createConfetti();
            } else {
                feedbackContainer.classList.remove('bg-green-100', 'dark:bg-green-900');
                feedbackContainer.classList.add('bg-red-100', 'dark:bg-red-900');
                feedbackIcon.classList.remove('fa-check-circle', 'text-green-500');
                feedbackIcon.classList.add('fa-times-circle', 'text-red-500');
                feedbackTitle.textContent = 'Incorrect';
                feedbackTitle.classList.remove('text-green-700', 'dark:text-green-300');
                feedbackTitle.classList.add('text-red-700', 'dark:text-red-300');
            }
            
            // Set explanation text
            feedbackText.textContent = gameState.currentQuestion.explanation;
            
            // Show correct objection if wrong
            if (!isCorrect) {
                let correctObjText = '';
                if (gameState.currentQuestion.correctObjections.includes('no-objection')) {
                    correctObjText = 'The correct answer is: No Objection';
                } else {
                    const objectionNames = {
                        'relevance': 'Relevance',
                        'hearsay': 'Hearsay',
                        'leading': 'Leading Question',
                        'speculation': 'Speculation',
                        'compound': 'Compound Question',
                        'assumes-facts': 'Assumes Facts Not in Evidence',
                        'argumentative': 'Argumentative',
                        'narrative': 'Calls for Narrative',
                        'legal-conclusion': 'Calls for Legal Conclusion',
                        'vague': 'Vague/Ambiguous',
                        'calls for expert opinion': 'Calls for Expert Opinion'
                    };
                    
                    const formattedObjections = gameState.currentQuestion.correctObjections.map(
                        obj => objectionNames[obj] || obj
                    );
                    
                    correctObjText = 'The correct objection' + 
                        (formattedObjections.length > 1 ? 's are' : ' is') + 
                        ': ' + formattedObjections.join(', ');
                }
                correctObjectionElement.textContent = correctObjText;
                correctObjectionElement.classList.remove('hidden');
            } else {
                correctObjectionElement.classList.add('hidden');
            }
            
            // Show feedback container
            feedbackContainer.classList.remove('hidden');
            feedbackContainer.classList.add('appear');
        }

        // Move to next question
        nextQuestionButton.addEventListener('click', () => {
            loadNextQuestion();
        });

        // End game and show results
        function endGame() {
            gameScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
            
            // Update results screen
            document.getElementById('final-score').textContent = gameState.score;
            document.getElementById('total-possible').textContent = gameState.totalQuestions * 10;
            document.getElementById('correct-objections').textContent = gameState.correctAnswers;
            document.getElementById('incorrect-objections').textContent = gameState.incorrectAnswers;
            document.getElementById('highest-streak').textContent = gameState.highestStreak;
            
            const accuracy = gameState.totalQuestions > 0 
                ? Math.round((gameState.correctAnswers / gameState.totalQuestions) * 100) 
                : 0;
            document.getElementById('accuracy-percentage').textContent = accuracy + '%';
            
            // Set performance message
            const performanceMessage = document.getElementById('performance-message');
            
            if (gameState.difficulty === 'trial') {
                const trialTitle = gameState.trialName || "Trial";
                performanceMessage.textContent = `${trialTitle} Complete - Accuracy: ${accuracy}%`;
                performanceMessage.className = 'mt-2 text-lg text-purple-600 dark:text-purple-400';
            } else if (accuracy >= 90) {
                performanceMessage.textContent = 'Outstanding! You\'re ready for the courtroom!';
                performanceMessage.className = 'mt-2 text-lg text-green-600 dark:text-green-400';
            } else if (accuracy >= 70) {
                performanceMessage.textContent = 'Good job! You\'re well on your way to becoming a skilled attorney.';
                performanceMessage.className = 'mt-2 text-lg text-blue-600 dark:text-blue-400';
            } else if (accuracy >= 50) {
                performanceMessage.textContent = 'Not bad! With more practice, you\'ll improve your objection skills.';
                performanceMessage.className = 'mt-2 text-lg text-yellow-600 dark:text-yellow-400';
            } else {
                performanceMessage.textContent = 'Keep studying! Legal objections take time to master.';
                performanceMessage.className = 'mt-2 text-lg text-red-600 dark:text-red-400';
            }
        }

        // Play again button
        playAgainButton.addEventListener('click', () => {
            if (gameState.difficulty === 'trial') {
                // For trial mode, go back to trial selection
                resultsScreen.classList.add('hidden');
                showTrialSelection();
            } else {
                startGame(gameState.difficulty);
            }
        });

        // Return to home button
        returnHomeButton.addEventListener('click', () => {
            resultsScreen.classList.add('hidden');
            trialSelectionScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
        });

        // End game early
        endGameButton.addEventListener('click', () => {
            endGame();
        });

        // Add event listener for back-to-home button
        backToHomeButton.addEventListener('click', () => {
            trialSelectionScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
        });

        document.getElementById('generate-certificate').addEventListener('click', generateCertificate);

        document.getElementById('generate-certificate').addEventListener('click', generateCertificate);

function generateCertificate() {
    const playerName = document.getElementById('player-name').value.trim();
    if (!playerName) {
        alert('Please enter your name to generate a certificate.');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: 'landscape',
        unit: 'mm',
        format: 'a4'
    });

    // 🎨 Background Color (Soft Ivory for Prestige)
    doc.setFillColor(255, 253, 245);
    doc.rect(0, 0, 297, 210, 'F');

    // ✨ Elegant Gold Border with Double Line
    doc.setDrawColor(218, 165, 32);
    doc.setLineWidth(3);
    doc.rect(12, 12, 273, 186);
    doc.setLineWidth(1);
    doc.rect(18, 18, 261, 174);

    // 🏛️ Title: "Certificate of Achievement"
    doc.setFont('times', 'bolditalic');
    doc.setTextColor(33, 33, 33);
    doc.setFontSize(36);
    doc.text('Certificate of Achievement', 148.5, 40, { align: 'center' });

    // 📜 Decorative Line
    doc.setLineWidth(1);
    doc.line(90, 45, 207, 45);

    // 🎖️ Subtitle
    doc.setFontSize(22);
    doc.setFont('times', 'italic');
    doc.setTextColor(139, 69, 19); // Brown-gold accent
    doc.text('Presented to', 148.5, 60, { align: 'center' });

    // 🏆 Awardee Name (Bigger, Royal Blue)
    doc.setFont('times', 'bold');
    doc.setFontSize(30);
    doc.setTextColor(0, 0, 128);
    doc.text(playerName, 148.5, 78, { align: 'center' });

    // 🏅 Recognition Text
    doc.setFontSize(16);
    doc.setFont('times', 'italic');
    doc.setTextColor(33, 33, 33);
    doc.text(`For demonstrating outstanding legal expertise in`, 148.5, 95, { align: 'center' });
    doc.setFont('times', 'bold');
    
    // Special text for trial mode
    if (gameState.difficulty === 'trial') {
        doc.text(`Objection Mayhem - ${gameState.trialName}`, 148.5, 110, { align: 'center' });
    } else {
        doc.text(`Objection Mayhem`, 148.5, 110, { align: 'center' });
    }

    // 🏆 Performance Metrics
    const score = gameState.score;
    const totalPossible = gameState.totalQuestions * 10;
    const accuracy = gameState.totalQuestions > 0 
        ? Math.round((gameState.correctAnswers / gameState.totalQuestions) * 100) 
        : 0;
    const legalNickname = getLegalNickname(accuracy);
    
    // Format difficulty text - show trial name if in trial mode
    const difficultyText = gameState.difficulty === 'trial' 
        ? 'Trial Mode' 
        : gameState.difficulty.charAt(0).toUpperCase() + gameState.difficulty.slice(1);

    doc.setFontSize(16);
    doc.setFont('times', 'normal');
    doc.text(`Score: ${score} / ${totalPossible} | Difficulty: ${difficultyText}`, 148.5, 125, { align: 'center' });

    // ✨ Awarded Title (Gold Font)
    doc.setFontSize(22);
    doc.setFont('times', 'bolditalic');
    doc.setTextColor(218, 165, 32);
    doc.text(`Earning the title: "${legalNickname}"`, 148.5, 142, { align: 'center' });

    // 📅 Date of Issue
    const today = new Date();
    const dateString = today.toLocaleDateString();
    doc.setFontSize(14);
    doc.setTextColor(33, 33, 33);
    doc.text(`Issued on: ${dateString}`, 148.5, 157, { align: 'center' });

    // 🏛️ Signature (Script Font)
    doc.setFont('cursive');  
    doc.setFontSize(26);
    doc.text('Stevo Alexander', 148.5, 175, { align: 'center' });

    // ✏️ Signature Line & Title
    doc.setDrawColor(0, 0, 0);
    doc.setLineWidth(0.5);
    doc.line(89, 180, 208, 180);
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    doc.text('Judge of Objection Mayhem', 148.5, 188, { align: 'center' });

    // 💾 Save the Certificate
    doc.save(`objection-mayhem-certificate-${playerName.replace(/\s+/g, '-').toLowerCase()}.pdf`);
}

function getLegalNickname(accuracy) {
    if (accuracy >= 95) return "The Supreme Justice";
    if (accuracy >= 90) return "Legal Eagle";
    if (accuracy >= 85) return "Master of Objections";
    if (accuracy >= 80) return "The Law Hammer";
    if (accuracy >= 75) return "Courtroom Virtuoso";
    if (accuracy >= 70) return "The Case Closer";
    if (accuracy >= 65) return "Objection Specialist";
    if (accuracy >= 60) return "Rising Attorney";
    if (accuracy >= 50) return "Litigation Apprentice";
    if (accuracy >= 40) return "Junior Counselor";
    if (accuracy >= 30) return "Law Student";
    if (accuracy >= 20) return "Legal Intern";
    return "Aspiring Attorney";
}


        // Add objection details modal functionality
        const objectionModal = document.getElementById('objection-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const closeModal = document.getElementById('close-modal');
        const objectionCards = document.querySelectorAll('.objection-card');

        // Objection details database with extended information
        const objectionDetails = {
            relevance: {
                title: "Relevance",
                description: "An objection on the grounds of relevance is raised when a question, evidence, or testimony has no logical connection to the facts in issue or the elements that need to be proven in the case.",
                legalBasis: "Evidence must be both logically and legally relevant to be admissible. Under Federal Rule of Evidence 401, evidence is relevant if it has any tendency to make a fact more or less probable and the fact is of consequence in determining the action.",
                examples: [
                    "<strong>Attorney:</strong> \"What color was your car in high school?\"<br><strong>Objection:</strong> Relevance (in a case about a recent car accident where the witness's high school car isn't at issue)",
                    "<strong>Attorney:</strong> \"Do you enjoy fishing on weekends?\"<br><strong>Objection:</strong> Relevance (in a workplace discrimination case where the witness's hobbies are unrelated)",
                    "<strong>Attorney:</strong> \"How many speeding tickets has the defendant received in his lifetime?\"<br><strong>Objection:</strong> Relevance (in a breach of contract case unrelated to driving)"
                ],
                whenToUse: "Use this objection when the question has no bearing on proving or disproving any element of the claims or defenses in the case. However, be aware that courts often give attorneys some leeway, especially during cross-examination, to establish context or credibility."
            },
            hearsay: {
                title: "Hearsay",
                description: "Hearsay is an out-of-court statement offered to prove the truth of the matter asserted in the statement. It's generally inadmissible because the declarant (person who made the statement) isn't subject to cross-examination about their perception, memory, or truthfulness.",
                legalBasis: "Federal Rule of Evidence 802 prohibits hearsay evidence, though there are numerous exceptions found in Rules 803, 804, and 807. The core concern is the reliability of second-hand information.",
                examples: [
                    "<strong>Attorney:</strong> \"What did your neighbor tell you about the accident?\"<br><strong>Objection:</strong> Hearsay (if offered to prove what happened in the accident)",
                    "<strong>Attorney:</strong> \"According to the sales report your colleague prepared, what were the quarterly figures?\"<br><strong>Objection:</strong> Hearsay (if the colleague isn't testifying)",
                    "<strong>Attorney:</strong> \"Your friend told you the defendant was angry that day, correct?\"<br><strong>Objection:</strong> Hearsay (if offered to prove the defendant's emotional state)"
                ],
                whenToUse: "Use when a witness is being asked to repeat someone else's statement to prove that statement is true. Remember that many exceptions exist, such as excited utterances, present sense impressions, business records, and statements against interest."
            },
            leading: {
                title: "Leading Question",
                description: "A leading question suggests the desired answer within the question itself. These questions often can be answered with a simple 'yes' or 'no' and typically contain the information the attorney wants the witness to confirm rather than eliciting the witness's own words.",
                legalBasis: "Federal Rule of Evidence 611(c) prohibits leading questions on direct examination, except as necessary to develop the witness's testimony. They are generally permitted on cross-examination.",
                examples: [
                    "<strong>Attorney on Direct:</strong> \"You were scared when you saw the gun, weren't you?\"<br><strong>Objection:</strong> Leading (suggests that the witness was scared)",
                    "<strong>Attorney on Direct:</strong> \"The light was red when the defendant drove through the intersection, correct?\"<br><strong>Objection:</strong> Leading (provides the witness with the conclusion)",
                    "<strong>Attorney on Direct:</strong> \"You saw the defendant take the money from the register, didn't you?\"<br><strong>Objection:</strong> Leading (suggests the witness saw a specific action)"
                ],
                whenToUse: "Use during direct examination when opposing counsel is suggesting answers to their own witness. Don't object during cross-examination, as leading questions are permitted. Some exceptions during direct examination include preliminary matters, hostile witnesses, or child witnesses."
            },
            speculation: {
                title: "Speculation",
                description: "An objection to speculation challenges a question that asks the witness to guess, make assumptions, or offer opinions beyond their personal knowledge or expertise. Witnesses should generally testify only to facts they personally perceived.",
                legalBasis: "Federal Rule of Evidence 602 requires that witnesses have personal knowledge of the matter about which they testify. Rule 701 limits lay opinion testimony to those rationally based on perception and helpful to understanding the testimony.",
                examples: [
                    "<strong>Attorney:</strong> \"What do you think the defendant was thinking when he signed the contract?\"<br><strong>Objection:</strong> Calls for speculation (about another person's thoughts)",
                    "<strong>Attorney:</strong> \"If the safety guard had been installed, would the accident have been prevented?\"<br><strong>Objection:</strong> Calls for speculation (about hypothetical scenario)",
                    "<strong>Attorney:</strong> \"Why do you think the other driver didn't stop at the sign?\"<br><strong>Objection:</strong> Calls for speculation (about another's motivations)"
                ],
                whenToUse: "Use when a question asks the witness to guess about matters outside their direct knowledge, hypothetical scenarios, others' mental states, or makes predictions without proper foundation. Expert witnesses have more latitude to offer opinions based on hypotheticals."
            },
            compound: {
                title: "Compound Question",
                description: "A compound question improperly combines two or more separate questions into one. This creates ambiguity because it's unclear which part of the compound question the witness is answering, potentially confusing the record and the jury.",
                legalBasis: "While not explicitly addressed in the Federal Rules of Evidence, compound questions are objectionable under Rule 611(a), which gives courts control over questioning to make procedures effective and protect witnesses from harassment or undue embarrassment.",
                examples: [
                    "<strong>Attorney:</strong> \"Did you see the accident and did you call the police?\"<br><strong>Objection:</strong> Compound (combines witnessing with reporting)",
                    "<strong>Attorney:</strong> \"Was the defendant speeding and did he run the red light?\"<br><strong>Objection:</strong> Compound (combines two different traffic violations)",
                    "<strong>Attorney:</strong> \"Did you review the contract and did you find it acceptable?\"<br><strong>Objection:</strong> Compound (combines reading with evaluation)"
                ],
                whenToUse: "Object when a question contains multiple inquiries joined by 'and' or 'or' that should be addressed separately. This is especially important when the answer might be different for each part of the question."
            },
            "assumes-facts": {
                title: "Assumes Facts Not in Evidence",
                description: "This objection applies when a question assumes as true a fact that hasn't been established by testimony or admitted into evidence. Such questions can be misleading by slipping in unproven assumptions.",
                legalBasis: "Federal Rule of Evidence 611(a) gives courts control over questioning to make testimony effective and avoid wasting time. Questions that assume unproven facts violate this principle and can prejudice the jury.",
                examples: [
                    "<strong>Attorney:</strong> \"When did you stop falsifying company records?\"<br><strong>Objection:</strong> Assumes facts not in evidence (assumes records were falsified)",
                    "<strong>Attorney:</strong> \"Why didn't you help the victim after the accident?\"<br><strong>Objection:</strong> Assumes facts not in evidence (assumes the witness was present and didn't help)",
                    "<strong>Attorney:</strong> \"How many drinks did the defendant have before driving?\"<br><strong>Objection:</strong> Assumes facts not in evidence (if there's no evidence the defendant had any drinks)"
                ],
                whenToUse: "Use when a question contains an embedded assumption that hasn't been established. Be alert for questions that begin with 'when,' 'where,' 'how,' or 'why' that might smuggle in unproven facts."
            },
            argumentative: {
                title: "Argumentative",
                description: "An argumentative question is one that challenges the witness rather than seeks information. These questions often aim to argue with the witness, make speeches to the jury, or force the witness to adopt the attorney's characterizations or conclusions.",
                legalBasis: "Federal Rule of Evidence 611(a) gives courts control over examining witnesses to make testimony effective and protect witnesses from harassment. Argumentative questions go beyond legitimate examination.",
                examples: [
                    "<strong>Attorney:</strong> \"You're just making this up as you go along, aren't you?\"<br><strong>Objection:</strong> Argumentative (attacks witness credibility rather than seeking information)",
                    "<strong>Attorney:</strong> \"Given your history of lying, why should anyone believe your testimony today?\"<br><strong>Objection:</strong> Argumentative (makes an argument rather than asking a question)",
                    "<strong>Attorney:</strong> \"You didn't really care about safety protocols, did you?\"<br><strong>Objection:</strong> Argumentative (characterizes witness attitude rather than seeking facts)"
                ],
                whenToUse: "Object when opposing counsel is engaging in argument with the witness rather than eliciting testimony, using rhetorical questions, or making speeches disguised as questions. Distinguished from tough but legitimate cross-examination."
            },
            narrative: {
                title: "Calls for Narrative",
                description: "This objection is used when a question invites the witness to give an extended, open-ended response rather than answering a specific inquiry. Narrative questions may elicit irrelevant, nonresponsive, or inadmissible information.",
                legalBasis: "While not explicitly addressed in the Federal Rules of Evidence, narrative objections stem from Rule 611(a), which promotes efficient questioning and gives courts authority to exercise control over witness examination.",
                examples: [
                    "<strong>Attorney:</strong> \"Tell us everything that happened that day.\"<br><strong>Objection:</strong> Calls for narrative (overly broad time frame)",
                    "<strong>Attorney:</strong> \"Describe your entire employment history with the company.\"<br><strong>Objection:</strong> Calls for narrative (lacks specificity)",
                    "<strong>Attorney:</strong> \"What do you recall about the contract negotiations?\"<br><strong>Objection:</strong> Calls for narrative (open-ended about complex process)"
                ],
                whenToUse: "Use when a question is so open-ended that it invites a rambling answer, likely containing inadmissible content. However, some narrative testimony may be appropriate to establish background or context, and judges often have discretion to allow limited narrative responses."
            },
            "legal-conclusion": {
                title: "Calls for Legal Conclusion",
                description: "This objection applies when a question asks a lay witness to offer an opinion on a legal issue or standard that should be determined by the judge or jury. Witnesses should generally testify to facts, not legal interpretations.",
                legalBasis: "Under Federal Rules of Evidence 701 and 702, lay witnesses may only offer opinions rationally based on their perception, not specialized knowledge including legal conclusions. Only the judge can instruct on the law.",
                examples: [
                    "<strong>Attorney:</strong> \"In your opinion, was the defendant negligent?\"<br><strong>Objection:</strong> Calls for a legal conclusion (negligence is a legal standard)",
                    "<strong>Attorney:</strong> \"Do you believe the contract was legally binding?\"<br><strong>Objection:</strong> Calls for a legal conclusion (validity of contracts is a legal determination)",
                    "<strong>Attorney:</strong> \"Would you say the officer had probable cause for the arrest?\"<br><strong>Objection:</strong> Calls for a legal conclusion (probable cause is a legal standard)"
                ],
                whenToUse: "Use when a question asks a lay witness to apply legal standards or make legal determinations. Expert witnesses may have more leeway to discuss ultimate issues, but even they cannot usurp the role of the judge in interpreting law."
            },
            vague: {
                title: "Vague/Ambiguous",
                description: "This objection challenges questions that are unclear, imprecise, or could be interpreted in multiple ways. Vague questions create confusion and may lead to unreliable testimony because the witness may not understand what information is being sought.",
                legalBasis: "Federal Rule of Evidence 611(a) promotes questioning that is clear and effective for ascertaining the truth. Vague or ambiguous questions undermine this goal by creating confusion in the record.",
                examples: [
                    "<strong>Attorney:</strong> \"What happened with that thing at that time?\"<br><strong>Objection:</strong> Vague/Ambiguous (lacks specific reference points)",
                    "<strong>Attorney:</strong> \"Did they act appropriately?\"<br><strong>Objection:</strong> Vague/Ambiguous (undefined standard of 'appropriate')",
                    "<strong>Attorney:</strong> \"Were you there when it occurred?\"<br><strong>Objection:</strong> Vague/Ambiguous (unclear what 'it' refers to)"
                ],
                whenToUse: "Object when a question contains undefined terms, unclear referents (like 'it' or 'they' without clear antecedents), or could be reasonably interpreted in multiple ways. The goal is to ensure that both the witness and fact-finder clearly understand what is being asked."
            }
        };

        // Add click event listeners to objection cards
        objectionCards.forEach(card => {
            card.addEventListener('click', () => {
                const objectionType = card.dataset.objection;
                const details = objectionDetails[objectionType];
                
                if (details) {
                    // Populate modal with objection details
                    modalTitle.textContent = details.title;
                    
                    let contentHTML = `
                        <div class="text-gray-700 dark:text-gray-300">
                            <p class="mb-4">${details.description}</p>
                            
                            <h3 class="text-lg font-semibold text-primary mt-6 mb-2">Legal Basis</h3>
                            <p class="mb-4">${details.legalBasis}</p>
                            
                            <h3 class="text-lg font-semibold text-primary mt-6 mb-2">Examples</h3>
                            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
                                ${details.examples.map(example => `<div class="mb-3">${example}</div>`).join('')}
                            </div>
                            
                            <h3 class="text-lg font-semibold text-primary mt-6 mb-2">When to Use</h3>
                            <p>${details.whenToUse}</p>
                        </div>
                    `;
                    
                    modalContent.innerHTML = contentHTML;
                    
                    // Show modal
                    objectionModal.classList.remove('hidden');
                }
            });
        });

        // Close modal when clicking close button
        closeModal.addEventListener('click', () => {
            objectionModal.classList.add('hidden');
        });

        // Close modal when clicking outside content area
        objectionModal.addEventListener('click', (event) => {
            if (event.target === objectionModal) {
                objectionModal.classList.add('hidden');
            }
        });

        // Close modal with escape key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !objectionModal.classList.contains('hidden')) {
                objectionModal.classList.add('hidden');
            }
        });

        // Trial Narrative Modal for immersive trial experience
        const trialNarrativeModal = document.createElement('div');
        trialNarrativeModal.id = 'trial-narrative-modal';
        trialNarrativeModal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden';
        trialNarrativeModal.innerHTML = `
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full p-8 relative">
                <div class="absolute top-4 right-4">
                    <button id="skip-narrative" class="text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        Skip <i class="fas fa-forward ml-1"></i>
                    </button>
                </div>
                <div id="narrative-content" class="space-y-6">
                    <h2 id="narrative-title" class="text-2xl font-bold text-primary text-center"></h2>
                    <div id="narrative-body" class="prose dark:prose-invert max-w-none">
                        <!-- Content will be populated dynamically -->
                    </div>
                    <div class="flex justify-center mt-8">
                        <button id="narrative-next" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors">
                            Continue <i class="fas fa-arrow-right ml-1"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(trialNarrativeModal);

        // Trial narrative functionality
        const trialNarrativeHandler = {
            modal: trialNarrativeModal,
            titleElement: null,
            bodyElement: null,
            nextButton: null,
            skipButton: null,
            currentTrial: null,
            currentStage: 0,
            prosecutionWitnesses: [],
            defenseWitnesses: [],
            currentSide: 'prosecution',
            currentWitnessIndex: 0,
            onComplete: null,
            
            init: function() {
                this.titleElement = document.getElementById('narrative-title');
                this.bodyElement = document.getElementById('narrative-body');
                this.nextButton = document.getElementById('narrative-next');
                this.skipButton = document.getElementById('skip-narrative');
                
                this.nextButton.addEventListener('click', () => this.advance());
                
                // Change skip button behavior to skip to questioning without ending trial
                this.skipButton.addEventListener('click', () => this.skipToQuestioning());
            },
            
            startTrial: function(trial, onCompleteCallback) {
                this.currentTrial = trial;
                this.currentStage = 0;
                this.onComplete = onCompleteCallback;
                
                // Split witnesses into prosecution and defense
                this.prosecutionWitnesses = [];
                this.defenseWitnesses = [];
                
                if (trial.witnesses) {
                    // Use structured witness data if available
                    trial.witnesses.forEach(witness => {
                        if (witness.side === 'prosecution') {
                            this.prosecutionWitnesses.push(witness);
                        } else if (witness.side === 'defense') {
                            this.defenseWitnesses.push(witness);
                        }
                    });
                } else {
                    // Fallback: split questions evenly between prosecution and defense
                    const halfwayPoint = Math.ceil(trial.questions.length / 2);
                    
                    // Create a default prosecution witness with the first half of questions
                    this.prosecutionWitnesses.push({
                        name: "Prosecution Witness",
                        questions: trial.questions.slice(0, halfwayPoint)
                    });
                    
                    // Create a default defense witness with the second half of questions
                    if (halfwayPoint < trial.questions.length) {
                        this.defenseWitnesses.push({
                            name: "Defense Witness",
                            questions: trial.questions.slice(halfwayPoint)
                        });
                    }
                }
                
                this.currentSide = 'prosecution';
                this.currentWitnessIndex = 0;
                
                // Show statement of facts
                this.showStatementOfFacts();
            },
            
            showStatementOfFacts: function() {
                this.titleElement.textContent = `${this.currentTrial.name} - Statement of Facts`;
                
                let factsHtml = this.currentTrial.statementOfFacts || 
                    "<p>This is a trial about a disputed matter. You will hear testimony from both the prosecution and defense witnesses.</p>";
                
                this.bodyElement.innerHTML = factsHtml;
                this.modal.classList.remove('hidden');
                this.currentStage = 1;
            },
            
            showProsecutionIntro: function() {
                this.titleElement.textContent = "Prosecution's Case";
                this.bodyElement.innerHTML = `
                    <p class="text-center"><i class="fas fa-gavel text-primary text-3xl mb-4"></i></p>
                    <p>The prosecution calls its first witness.</p>
                    <p class="font-medium">You are acting as defense counsel's <span class="text-primary">objection assistant</span>. Your role is to identify improper questions and make appropriate objections to protect your client's interests.</p>
                    <p class="mt-3">Although you're not conducting the examination yourself, you're responsible for monitoring the opposing counsel's questions and raising objections when they violate the rules of evidence.</p>
                    <p class="text-sm mt-4 italic">Remember: Only object when there is a valid legal basis to do so. Your co-counsel relies on you to spot problems!</p>
                `;
                this.modal.classList.remove('hidden');
                this.currentStage = 2;
            },
            
            showDefenseIntro: function() {
                // Keep the role switch modal functionality
                const roleModal = document.getElementById('role-switch-modal');
                roleModal.classList.remove('hidden');
                
                document.getElementById('continue-trial').addEventListener('click', () => {
                    roleModal.classList.add('hidden');
                    
                    this.titleElement.textContent = "Defense's Case";
                    this.bodyElement.innerHTML = `
                        <p class="text-center"><i class="fas fa-balance-scale text-primary text-3xl mb-4"></i></p>
                        <p>The defense calls its first witness.</p>
                        <p class="font-medium">You are now acting as the <span class="text-primary">prosecutor's objection assistant</span>. Your role is to identify when the defense attorney's questions violate the rules of evidence.</p>
                        <p class="mt-3">Although you don't ask the questions yourself, you must carefully monitor each question to ensure it follows proper procedure and object when necessary.</p>
                        <p class="text-sm mt-4 italic">The burden of proof remains with the prosecution, and your vigilance helps maintain the integrity of the process.</p>
                    `;
                    this.modal.classList.remove('hidden');
                    this.currentStage = 4;
                }, { once: true });
            },
            
            showWitnessTransition: function() {
                const witnesses = this.currentSide === 'prosecution' ? 
                    this.prosecutionWitnesses : this.defenseWitnesses;
                    
                if (this.currentWitnessIndex >= witnesses.length) {
                    // No more witnesses on this side
                    if (this.currentSide === 'prosecution') {
                        this.currentSide = 'defense';
                        this.currentWitnessIndex = 0;
                        this.showDefenseIntro();
                    } else {
                        // Trial complete
                        this.showTrialConclusion();
                    }
                    return;
                }
                
                const currentWitness = witnesses[this.currentWitnessIndex];
                this.titleElement.textContent = `${currentWitness.name || 'Witness'} Takes the Stand`;
                
                const side = this.currentSide === 'prosecution' ? 'Prosecution' : 'Defense';
                this.bodyElement.innerHTML = `
                    <p class="text-center"><i class="fas fa-user text-primary text-3xl mb-4"></i></p>
                    <p>The ${side.toLowerCase()} calls ${currentWitness.name || 'the next witness'}.</p>
                    <p class="italic">${currentWitness.description || `This witness will testify about matters relevant to the ${this.currentSide}'s case.`}</p>
                    <p class="mt-4">Prepare to evaluate the questions for objections.</p>
                `;
                this.modal.classList.remove('hidden');
                this.currentStage = this.currentSide === 'prosecution' ? 3 : 5;
            },
            
            showTrialConclusion: function() {
                this.titleElement.textContent = "Trial Concluded";
                this.bodyElement.innerHTML = `
                    <p class="text-center"><i class="fas fa-flag-checkered text-primary text-3xl mb-4"></i></p>
                    <p>All witnesses have been examined and the trial has concluded.</p>
                    <p class="font-medium mt-4">Let's review your performance as both defense counsel and prosecutor.</p>
                `;
                this.modal.classList.remove('hidden');
                this.currentStage = 6;
            },
            
            advance: function() {
                this.modal.classList.add('hidden');
                
                switch (this.currentStage) {
                    case 1: // After statement of facts
                        this.showProsecutionIntro();
                        break;
                    case 2: // After prosecution intro
                        this.showWitnessTransition();
                        break;
                    case 3: // After prosecution witness intro
                        // Start questioning with current prosecution witness
                        this.startQuestioning();
                        break;
                    case 4: // After defense intro
                        this.showWitnessTransition();
                        break;
                    case 5: // After defense witness intro
                        // Start questioning with current defense witness
                        this.startQuestioning();
                        break;
                    case 6: // After trial conclusion
                        this.complete();
                        break;
                }
            },
            
            startQuestioning: function() {
                // Get current witness questions
                const witnesses = this.currentSide === 'prosecution' ? 
                    this.prosecutionWitnesses : this.defenseWitnesses;
                
                if (this.currentWitnessIndex < witnesses.length) {
                    const currentWitness = witnesses[this.currentWitnessIndex];
                    
                    if (this.onComplete) {
                        // Call the callback to start questioning
                        this.onComplete({
                            questions: currentWitness.questions || [],
                            witness: currentWitness,
                            side: this.currentSide,
                            onWitnessComplete: () => {
                                // Move to next witness
                                this.currentWitnessIndex++;
                                this.showWitnessTransition();
                            }
                        });
                    }
                }
            },
            
            complete: function() {
                this.modal.classList.add('hidden');
                if (this.onComplete) {
                    this.onComplete(null); // Signal completion with null
                }
            },
            
            // New method to skip narrative and jump to questioning
            skipToQuestioning: function() {
                this.modal.classList.add('hidden');
                
                // Based on current stage, determine what to do
                if (this.currentStage <= 3) {
                    // If we're in prosecution phase or earlier, set up first prosecution witness
                    this.currentSide = 'prosecution';
                    this.currentWitnessIndex = 0;
                    if (this.prosecutionWitnesses.length > 0) {
                        const currentWitness = this.prosecutionWitnesses[this.currentWitnessIndex];
                        if (this.onComplete) {
                            this.onComplete({
                                questions: currentWitness.questions || [],
                                witness: currentWitness,
                                side: this.currentSide,
                                onWitnessComplete: () => {
                                    this.currentWitnessIndex++;
                                    this.showWitnessTransition();
                                }
                            });
                        }
                    } else {
                        // No prosecution witnesses - move to defense
                        this.currentSide = 'defense';
                        this.currentWitnessIndex = 0;
                        if (this.defenseWitnesses.length > 0) {
                            const currentWitness = this.defenseWitnesses[this.currentWitnessIndex];
                            if (this.onComplete) {
                                this.onComplete({
                                    questions: currentWitness.questions || [],
                                    witness: currentWitness,
                                    side: this.currentSide,
                                    onWitnessComplete: () => {
                                        this.currentWitnessIndex++;
                                        this.showWitnessTransition();
                                    }
                                });
                            }
                        } else {
                            // No witnesses at all - end the trial
                            this.complete();
                        }
                    }
                } else if (this.currentStage <= 5) {
                    // If we're in defense phase, set up first defense witness
                    this.currentSide = 'defense';
                    this.currentWitnessIndex = 0;
                    if (this.defenseWitnesses.length > 0) {
                        const currentWitness = this.defenseWitnesses[this.currentWitnessIndex];
                        if (this.onComplete) {
                            this.onComplete({
                                questions: currentWitness.questions || [],
                                witness: currentWitness,
                                side: this.currentSide,
                                onWitnessComplete: () => {
                                    this.currentWitnessIndex++;
                                    this.showWitnessTransition();
                                }
                            });
                        }
                    } else {
                        // No defense witnesses - end the trial
                        this.complete();
                    }
                } else {
                    // If we're at the conclusion, complete the trial
                    this.complete();
                }
            }
        };
        
        // Initialize the trial narrative handler
        trialNarrativeHandler.init();

        // Modify startTrialGame function to use the new trial narrative flow
        function startTrialGame(trialIndex) {
            const selectedTrial = questionBanks.trials[trialIndex];
            
            // Calculate total questions for the trial
            let totalQuestions = 0;
            let allQuestions = [];
            
            if (selectedTrial.witnesses && Array.isArray(selectedTrial.witnesses)) {
                // New format with witnesses structure
                selectedTrial.witnesses.forEach(witness => {
                    if (witness.questions && Array.isArray(witness.questions)) {
                        totalQuestions += witness.questions.length;
                        allQuestions = allQuestions.concat(witness.questions);
                    }
                });
            } else if (selectedTrial.questions && Array.isArray(selectedTrial.questions)) {
                // Old format with direct questions array
                totalQuestions = selectedTrial.questions.length;
                allQuestions = [...selectedTrial.questions];
            }
            
            // Updated game state for trial mode
            gameState = {
                difficulty: 'trial',
                score: 0,
                questionsAsked: 0,
                totalQuestions: totalQuestions,
                currentQuestion: null,
                currentStreak: 0,
                highestStreak: 0,
                correctAnswers: 0,
                incorrectAnswers: 0,
                questionBank: [], // Will be set when witness questions start
                usedQuestions: [],
                currentTrial: selectedTrial,
                trialName: selectedTrial.name,
                trialIndex: trialIndex,
                currentWitness: null,
                currentSide: null,
                witnessQuestions: [],
                allQuestions: allQuestions // Store all questions for reference
            };
            
            // Update UI
            document.getElementById('score').textContent = '0';
            document.getElementById('question-number').textContent = '1';
            document.getElementById('total-questions').textContent = gameState.totalQuestions;
            
            // Set difficulty display
            const difficultyDisplay = document.getElementById('difficulty-display');
            difficultyDisplay.textContent = `Trial: ${gameState.trialName}`;
            difficultyDisplay.classList.add('bg-purple-100', 'text-purple-800');
            difficultyDisplay.classList.remove('bg-green-100', 'bg-yellow-100', 'bg-red-100', 
                'text-green-800', 'text-yellow-800', 'text-red-800');
            
            // Hide the trial selection screen
            trialSelectionScreen.classList.add('hidden');
            
            // Initialize the trial progress bar
            initializeTrialProgress(selectedTrial);
            
            // Start the trial narrative
            trialNarrativeHandler.startTrial(selectedTrial, function(witnessData) {
                if (!witnessData) {
                    // End the trial if witnessData is null (user clicked skip)
                    endGame();
                    return;
                }
                
                // Update game state with current witness data
                gameState.currentWitness = witnessData.witness;
                gameState.currentSide = witnessData.side;
                gameState.questionBank = [...witnessData.questions];
                gameState.witnessQuestions = witnessData.questions.length;
                gameState.onWitnessComplete = witnessData.onWitnessComplete;
                
                // Show game screen and start questioning
                gameScreen.classList.remove('hidden');
                loadNextQuestionForTrial();
            });
        }

        // New function for loading questions in trial mode
        function loadNextQuestionForTrial() {
            // Hide feedback container
            feedbackContainer.classList.add('hidden');
            
            // Enable all objection buttons
            objectionButtons.forEach(button => {
                button.disabled = false;
                button.classList.remove('bg-gray-300', 'cursor-not-allowed');
            });
            noObjectionButton.disabled = false;
            noObjectionButton.classList.remove('cursor-not-allowed');
            
            // Check if we've reached the end of current witness questions
            if (gameState.questionBank.length === 0) {
                // Call witness complete callback
                if (gameState.onWitnessComplete) {
                    gameState.onWitnessComplete();
                }
                return;
            }
            
            // Get the next question for this witness (in sequence)
            gameState.currentQuestion = gameState.questionBank.shift();
            
            // Update the context to show trial progress
            const contextElement = document.getElementById('question-context');
            const witnessName = gameState.currentWitness?.name || 'Witness';
            const side = gameState.currentSide === 'prosecution' ? 'Prosecution' : 'Defense';
            contextElement.textContent = `${side} questioning ${witnessName} - ${gameState.currentQuestion.context || ''}`;
            
            // Update question text
            document.getElementById('question-text').textContent = gameState.currentQuestion.question;
            
            // Update question number
            const questionNumber = gameState.questionsAsked + 1;
            document.getElementById('question-number').textContent = questionNumber;
            
            // Update the examination status
            if (gameState.currentQuestion) {
                const examinationTypeBadge = document.getElementById('examination-type-badge');
                const examinationRole = document.getElementById('examination-role');
                
                // Set examination type (direct vs cross)
                let isDirectExamination = true;
                if (gameState.currentQuestion.context && 
                    gameState.currentQuestion.context.toLowerCase().includes('cross')) {
                    isDirectExamination = false;
                }
                
                // Update the badge
                if (isDirectExamination) {
                    examinationTypeBadge.textContent = "Direct Examination";
                    examinationTypeBadge.className = "px-3 py-1 rounded-full text-sm font-medium mr-3 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200";
                } else {
                    examinationTypeBadge.textContent = "Cross-Examination";
                    examinationTypeBadge.className = "px-3 py-1 rounded-full text-sm font-medium mr-3 bg-amber-100 dark:bg-amber-900 text-amber-800 dark:text-amber-200";
                }
                
                // Update the role text based on which side the user is on
                if (gameState.currentSide === 'prosecution') {
                    examinationRole.textContent = "You are assisting as defense counsel";
                } else {
                    examinationRole.textContent = "You are assisting as prosecutor";
                }
            }
        }

        // Modify the checkAnswer function to support the trial flow
        const originalCheckAnswer = checkAnswer;
        checkAnswer = function(selectedObjection) {
            // Call the original function
            originalCheckAnswer(selectedObjection);
            
            // For trial mode, use the trial-specific next question function
            if (gameState.difficulty === 'trial') {
                // Override the next question button behavior
                document.getElementById('next-question').onclick = function() {
                    loadNextQuestionForTrial();
                };
            }
        };

    // Add this function to dynamically generate and update the trial progress bar
function initializeTrialProgress(trial) {
    const progressContainer = document.getElementById('trial-progress');
    const witnessContainer = document.getElementById('witness-progress-container');
    
    // Only show for trial mode
    if (!trial || gameState.difficulty !== 'trial') {
        progressContainer.classList.add('hidden');
        return;
    }
    
    // Show the progress bar
    progressContainer.classList.remove('hidden');
    witnessContainer.innerHTML = '';
    
    // Get all witnesses from the trial
    let witnesses = [];
    if (trial.witnesses && Array.isArray(trial.witnesses)) {
        witnesses = trial.witnesses;
    } else if (trial.questions && Array.isArray(trial.questions)) {
        // For older format, create dummy witnesses (prosecution & defense)
        witnesses = [
            { name: "Prosecution Witness", side: "prosecution" },
            { name: "Defense Witness", side: "defense" }
        ];
    }
    
    // Track when we switch from prosecution to defense
    let currentSide = null;
    
    // Create a progress step for each witness
    witnesses.forEach((witness, index) => {
        const witnessSide = witness.side || (index < Math.ceil(witnesses.length / 2) ? 'prosecution' : 'defense');
        
        // Add role switch icon if we're switching from prosecution to defense
        if (currentSide === 'prosecution' && witnessSide === 'defense') {
            // Add switch icon between prosecution and defense
            const switchIcon = document.createElement('div');
            switchIcon.className = 'flex flex-col items-center mx-1';
            switchIcon.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-primary bg-opacity-20 flex items-center justify-center">
                    <i class="fas fa-sync-alt text-primary"></i>
                </div>
                <span class="text-xs mt-1 text-center text-primary">Switch</span>
            `;
            witnessContainer.appendChild(switchIcon);
        }
        
        // Create the witness step
        const witnessStep = document.createElement('div');
        witnessStep.className = 'progress-step flex flex-col items-center';
        witnessStep.dataset.witness = index + 1;
        witnessStep.dataset.side = witnessSide;
        
        // Create witness circle
        const circle = document.createElement('div');
        circle.className = 'w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center transition-colors';
        circle.textContent = index + 1;
        
        // Add witness name - updated styling
        const name = document.createElement('span');
        name.className = 'text-xs mt-1 text-center';
        name.title = witness.name || `Witness ${index + 1}`;
        name.textContent = witness.name || `Witness ${index + 1}`;
        
        // Add data attribute for witness status
        witnessStep.dataset.status = 'pending';
        
        // Add elements to the witness step
        witnessStep.appendChild(circle);
        witnessStep.appendChild(name);
        witnessContainer.appendChild(witnessStep);
        
        // Add connecting line (except after the last witness)
        if (index < witnesses.length - 1) {
            // Don't add connecting line before the switch icon
            if (!(witnessSide === 'prosecution' && witnesses[index + 1].side === 'defense')) {
                const line = document.createElement('div');
                line.className = 'w-12 h-1 bg-gray-200 dark:bg-gray-700 self-center';
                line.dataset.lineIndex = index; // Add index for line tracking
                witnessContainer.appendChild(line);
            }
        }
        
        // Update current side for next iteration
        currentSide = witnessSide;
    });
    
    // Mark first witness as active by default if applicable
    if (witnesses.length > 0) {
        updateTrialProgress(0);
    }
}

// Add new function to update the trial progress
function updateTrialProgress(currentWitnessIndex) {
    const progressSteps = document.querySelectorAll('.progress-step');
    const progressLines = document.querySelectorAll('#witness-progress-container [data-line-index]');
    
    // Update each witness step status
    progressSteps.forEach((step, index) => {
        // Reset previous styling
        step.dataset.status = 'pending';
        const circle = step.querySelector('div:first-child');
        
        if (index < currentWitnessIndex) {
            // Completed witness - green
            step.dataset.status = 'completed';
            circle.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'ring-2', 'ring-primary');
            circle.classList.add('bg-green-500', 'dark:bg-green-600', 'text-white');
        } else if (index === currentWitnessIndex) {
            // Current witness - highlighted
            step.dataset.status = 'active';
            circle.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'bg-green-500', 'dark:bg-green-600');
            circle.classList.add('ring-2', 'ring-primary', 'bg-white', 'dark:bg-gray-800', 'text-primary');
            
            // Scroll this step into view if needed
            step.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        } else {
            // Future witness - neutral
            circle.classList.remove('bg-green-500', 'dark:bg-green-600', 'text-white', 'ring-2', 'ring-primary');
            circle.classList.add('bg-gray-200', 'dark:bg-gray-700');
        }
    });
    
    // Update connecting lines
    progressLines.forEach((line, index) => {
        if (index < currentWitnessIndex) {
            // Completed connection
            line.classList.remove('bg-gray-200', 'dark:bg-gray-700');
            line.classList.add('bg-green-500', 'dark:bg-green-600');
        } else {
            // Future connection
            line.classList.remove('bg-green-500', 'dark:bg-green-600');
            line.classList.add('bg-gray-200', 'dark:bg-gray-700');
        }
    });
}

// Update the trialNarrativeHandler.startQuestioning function to update progress bar
const originalStartQuestioning = trialNarrativeHandler.startQuestioning;
trialNarrativeHandler.startQuestioning = function() {
    // Get current witness index
    const currentWitnessIndex = this.currentWitnessIndex;
    const sideOffset = this.currentSide === 'defense' ? this.prosecutionWitnesses.length : 0;
    const globalWitnessIndex = sideOffset + currentWitnessIndex;
    
    // Update progress bar
    updateTrialProgress(globalWitnessIndex);
    
    // Call original function
    originalStartQuestioning.call(this);
};

    </script>


</body></html>